%=========================================================================
% (c) 2011, 2012 Josef Lusticky <xlusti00@stud.fit.vutbr.cz>

\chapter{NTP on other systems}

NTP daemon is an application running in user-space using kernel calls to adjust system time.
The kernel interface is...

\section{POSIX-compliant systems}\label{sec:posix}
POSIX standard
%The <time.h> header shall declare the timespec structure
\begin{lstlisting}[morekeywords={clockid_t,time_t}]
clock_gettime(clockid_t clock_id, struct timespec *res);
clock_settime(clockid_t clock_id, const struct timespec *res);
clock_getres(clockid_t clock_id, struct timespec *res);

struct timespec
time_t  tv_sec    Seconds
long    tv_nsec   Nanoseconds
\end{lstlisting}
A clock may be system-wide (that is, visible to all processes)
or per-process (measuring time that is meaningful only within a process).
All implementations shall support a clock\_id of CLOCK\_REALTIME as
defined in header file {\it{time.h}}.
This clock represents the clock measuring real time for the system.
For this clock, the values returned by clock\_gettime() and specified
by clock\_settime() represent the amount
of time (in seconds and nanoseconds) since the Epoch.


Operating systems:

Linux
OpenBSD - Kernel calls gettimeofday, settimeofday, adjtime, no kernel disciplne (timex structure)
as of OpenBSD 5.1 ntp\_gettime and ntp\_adjtime not implemented
DragonflyBSD - Kernel calls int ntp\_adjtime(struct timex *tp), BUT ONLY IN KERNEL: int ntp\_gettime(struct ntptimeval *ntv)

NTP implementations:

NTP from ntp.org project - reference implementation
Uses array for converting between Unix and NTP timestamp.
This approach does not fit for use with memory constrained systems.

Chrony

OpenNTPD - OpenBSD - secure, less robust, easy to configure
	/*
	 * Send out a random 64-bit number as our transmit time.  The NTP
	 * server will copy said number into the originate field on the
	 * response that it sends us.  This is totally legal per the SNTP spec.
	 *
	 * The impact of this is two fold: we no longer send out the current
	 * system time for the world to see (which may aid an attacker), and
	 * it gives us a (not very secure) way of knowing that we're not
	 * getting spoofed by an attacker that can't capture our traffic
	 * but can spoof packets from the NTP server we're communicating with.
	 *
	 * Save the real transmit timestamp locally.
	 */

dntpd - DragonflyBSD
only sends seconds
%wmsg.xmttime.int_partl = time(NULL) + JAN_1970;
%wmsg.xmttime.fractionl = random();


clockspeed

\section{Embedded systems}
Operating systems targeted at embedded devices
TinyOS
...
