%=========================================================================
% (c) 2011, 2012 Josef Lusticky <xlusti00@stud.fit.vutbr.cz>

\section{Network and timestamps}\label{sec:ntp-network}
Network specification of NTP defines that
the protocol uses the User Datagram Protocol (UDP) on port number 123~\cite{ianna-ports,rfc5905}.
Reliable message delivery such as TCP can actually make the delivered of
NTP packet less reliable since retries
would increase the delay value and other errors~\cite{rfc5905}.
This is mostly due to overhead of communication with TCP on transport layer.

NTP manipulates with the time through timestamps - a record of time.
NTP timestamp has two fields: the seconds field expressing the number of seconds
and the fraction field expressing fraction of a second~\cite{rfc5905}.
All NTP time values are represented in twos-complement format, with
bits numbered in big-endian fashion from zero starting at the left, or high-order, position~\cite{rfc5905}. 
There are two formats of timestamp in NTP packet structure:
long 64-bit and short 32-bit as shown on figure~\ref{fig:ntp-timestamps}.
The 64-bit long timestamp used by NTP consists of a 32-bit unsigned seconds
field spanning $2^{32}$ seconds (aprox. 136 years from 1900 to 2036) and a 32-bit fraction field resolving
$2^{-32}$ seconds (aprox. 232 picoseconds)~\cite{rfc5905}.
The short 32-bit timestamp includes a 16-bit unsigned seconds field
and 16-bit fraction field.

There is one more NTP time format - 128-bit NTP Date format.
It includes a 64-bit signed seconds field and 64-bit fraction field.
For convenience in mapping between formats,
the seconds field is divided into a 32-bit Era Number field
and a 32-bit Era Offset field.
This 128-bit NTP Date format is however not transmitted over the network
and is only used where sufficient storage and word
size is available~\cite{rfc5905}.
So there is practically no need of knowing about this format for embedded systems
at least until year 2036, when the Era Number will be incremented from zero to one.
But strictly speaking an NTP timestamp is a truncated NTP Date format~\cite{rfc5905}.
Refer to apendix~\ref{app:dates} for a short list of some dates
requiring usage of NTP Date format.

\begin{figure}
	\centering
	\includegraphics[width=13cm,keepaspectratio]{fig/ntp-timestamps.pdf}
	\caption{Time formats used in NTP packet}
	\label{fig:ntp-timestamps}
	\bigskip
\end{figure}

% TODO - packet description

\begin{figure}
	\centering
	\includegraphics[width=9cm,keepaspectratio]{fig/ntp-packet.pdf}
	\caption{Basic NTP packet structure by D. Mills}
	\label{fig:ntp-packet}
	\bigskip
\end{figure}

Because Root dispersion and Root Delay fields do not need so big scope and precision,
the short 32-bit format is used for them.
Root dispersion express accumulated total dispersion from primary server
and Root Delay express accumulated roundtrip delay via primary server~\cite{ntp-arch}.


%TODO

Because of network latency the timestamp recieved will never be exactly corresponding to
the current time.
One of the main goals of NTP is to deal with the network latency~\cite{ntp-overview}.
