%=========================================================================
% (c) 2011, 2012 Josef Lusticky


Getting the correct current time is only possible if it was set using
the {\it{clock\_set\_time}} function before.
Newly implemented function {\it{clock\_get\_time}} is then able to tell the
current time in seconds since the Epoch by simply adding {\it{boottime}},
and {\it{seconds}}.
%! TODO
Nanoseconds part is filled using {\it{scount}} variable counting number of
interrupts within a second.
Since this variable is incremented every interrupt and there are {\it{CLOCK\_SECOND}} interrupts
per second, it is possible to get resolution of $\frac{1~000~000~000}{CLOCK\_SECOND}$ ns.
The same resolution have Contiki timers, described in section~\ref{sec:contiki-timers}.
\begin{lstlisting}
void
clock_get_time(struct time_spec *ts)
{
  ts->sec = boottime + seconds;
  ts->nsec = (1000000000 / CLOCK_SECOND) * scount;
}
\end{lstlisting}
Because {\it{1000000000}} and {\it{CLOCK\_SECOND}} are both constants, the compiler is able to
calculate the result of division during compile time.
Furthermore as both numbers are integers, the result is integer as well~\cite{c99}.
The most of CPU time is therefore spent on multiplication.
E.g. if the code is compiled using GCC version 4.3.5,
multiplication of two 32-bit variables takes 33 instructions including {\it{call}} and {\it{ret}}
instructions for entering and returning from the {\it{\_\_mulsi3}} routine, which computes
the result of multiplication.
%avr-objdump
According to AVR Instruction Set manual~\cite{avr-instruction-set},
this results in 48 clock cycles overhead,
which takes 3~000 nanoseconds assuming 16MHz CPU clock.
The timestamp provided is therefore not exact.
However, since this consumed time strongly depends on architecture and compiler specifications,
no correction was implemented to remove this inaccuracy.
The application must be instead aware that the timestamp is not exactly accurate.

TODO: Greater precision is further implemented by reading counter register.

TODO: Adjust time
POSIX:
Time values that are between two consecutive non-negative integer multiples
of the resolution of the specified clock are truncated down to the smaller multiple of the resolution.
