\documentclass{article}
\usepackage{a4wide}
\begin{document}

\title{How to use AVR Studio 4 simulator with Contiki OS}
\author{Josef Lusticky}

\maketitle

As debugging using GDB might not be sufficient for all cases of development (such as the Timer/Counter modules),
this guide shows set up of AVR Studio 4 for simulation with Contiki project.

First of all we need a PC with Windows or Virtualbox with Windows installed on our Linux development PC.
The installation of Windows in Virtualbox is preferred because this way we can easily copy our compiled binaries
from the development Linux PC to Windows guest
without need of setting up build environment in Windows or network connection between two PCs.

\section{Installation}
Install Windows and the Guest addition in Windows if running under Virtualbox.
Set up shared folder (this needs the Guest additions) between your development host PC and virtual Windows PC, so you can copy files to Windows.
Install the AVR Studio version 4 (this version is easy to get working with Contiki and provides everything needed for simulation).

Copy the complete Contiki source code with your compiled project from your development PC to
{\it{C:\textbackslash YOUR\_HOME\_FOLDER\_ON\_DEVELOPMENT\_PC\textbackslash}}
on Windows - e.g. your contiki source code is located at {\it{/home/josef/contiki}}
then you have to copy Contiki to directory \\
{\it{C:\textbackslash home\textbackslash josef\textbackslash contiki}}.
By other words - the root directory on your development PC remains root directory on Windows.

Similarly copy the avr header files usually from {\it{/usr/lib/avr/include}} to
{\it{C:\textbackslash usr\textbackslash lib\textbackslash avr\textbackslash include}}
and the avr-gcc header files usually from {\it{/usr/lib/gcc/avr/}}VERSION{\it{/include}} to \\
{\it{C:\textbackslash usr\textbackslash lib\textbackslash gcc\textbackslash avr\textbackslash VERSION\textbackslash include}}
where VERSION can be determined from {\it{avr-gcc -v}} command.
If the headers files are not to be found in this paths, {\it{avr-gcc -vÂ }} command might help you to find them elsewhere.

If you will not stick to this paths on Windows,
you might be later asked by AVR Studio to locate these files and directories manually.


\section{Simulation}
Execute the AVR Studio 4. From the Startup dialog select Open and open to your Contiki binary ELF file for AVR target.
If the Startup dialog is not shown, go to menu File and select Open File.
You will be asked where to save your newly created AVR Studio project (.aps file).
Choose anything you like ({\it{My Documents\textbackslash AVR}} fits good).
Now you will be asked to select the debug platform and the device.
Choose AVR Simulator and ATmega1284P for AVR Raven. (There seems to be a problem with the newer Simulator 2 with Timer/Counter 2 module).
You may be asked if you want to load EEPROM data - click OK.
Now you can simulate and debug you Contiki project in AVR Studio 4.
To select CPU frequency go to menu Debug and select AVR Simulator Options.
The Debug menu has all you need to step through the code. The I/O view shows current status of the hardware.
\end{document}
