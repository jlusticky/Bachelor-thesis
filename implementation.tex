%=========================================================================
% (c) 2011, 2012 Josef Lusticky <xlusti00@stud.fit.vutbr.cz>

\chapter{NTP client in Contiki OS}
For implementation of reasonably useful NTP client,
operating system must be able to set, get
and eventually adjust time.
Though not mandatory, adjusting time is important function,
if the time shall be always a monotonically increasing function.
Apart from that, communicating abilities over UDP are also required.

Thanks to uIP, described in section~\ref{sec:contiki-uip}, communication is
not a matter for Contiki OS.
Contiki is also able to use Domain Name System for IPv4 address resolution.
DNS resolution of IPv6 addresses was not implemented in Contiki OS
at the time of writing~\cite{contiki-docs}.
The main problem of NTP client implementation for Contiki is therefore total
lack of real-time support.
Not only no common interface availability, but also
almost no platform-specific code has been implemented towards time support yet.
Contiki provides basic clock interface particularly for use of timers though.
This interface is common for all supported platforms,
but the particular implementation is platform specific.

Another deal might be possible packet loss if communication uses UDP on transport layer.
The reason why this can happen often is explained in section~\ref{sec:contiki-uip}.
However, packet loss is not a matter for NTP if using either broadcast or unicast mode.
In broadcast mode, lost server packet causes no setting or adjusting time of client's
local clock.
The client simply waits without disruption for next NTP broadcast message.
If client needs to figure out it's local clock offset at the moment,
it can simply query a server using NTP unicast mode.

In unicast mode packet loss might occur either for client's query to server
or for server's response to client.
If client's query loss occurs, no server response will be sent.
Similarly, if server's response loss occurs, no message will be received by the client.
It is therefore important not to block whole system till response arrives.
%TO COMMUNICATION: In Contiki the application is invoked in response to certain events
%... This can be effectively solved by NTP Poll Interval.

For developing and testing Contiki NTP client,
the AVR Raven platform with ATmega1284P CPU~\cite{avr-datasheet} was used.
% do not mention, appendix?
How to get a working setup with Contiki on this platform is described in
%!%% CHECK THIS %%%
docs/setup.pdf file on the CD enclosed to this thesis.
%%% CHECK THIS %%%

\input{implementation/clock.tex}

\input{implementation/interface.tex}

\input{implementation/client.tex}

\input{implementation/communication.tex}
